<!DOCTYPE html>
<html>

<head>
    <title>Read A SpreadSheet located in Google</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.12.4/xlsx.core.min.js"></script>

    <style name="page-select-style">
        .center {
            padding: 5pt;
            
            text-align: center;
        }
        
        a.item_page_panel {
            margin-left: 10pt;
        }
        

    </style>
</head>

<body>
    <script>
        var table = new Array();

        var query = "";
        var query_string;

        function parse_query_string(query) {
            var vars = query.split("&");
            var query_string = {};
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                var key = decodeURIComponent(pair[0]);
                var value = decodeURIComponent(pair[1]);
                // If first entry with this name
                if (typeof query_string[key] === "undefined") {
                    query_string[key] = decodeURIComponent(value);
                    // If second entry with this name
                } else if (typeof query_string[key] === "string") {
                    var arr = [query_string[key], decodeURIComponent(value)];
                    query_string[key] = arr;
                    // If third or later entry with this name
                } else {
                    query_string[key].push(decodeURIComponent(value));
                }
            }
            return query_string;
        }

        function ShowSelectPagePanel(table, container, curPage) {
            var panel = document.createElement('div');
            panel.id = 'page_panel';
            container.insertAdjacentElement('beforeend', panel);

            panel.className = "center";
            
            var first_page = 1, last_page = Math.floor(table.length / 10) + 1;

            panel.insertAdjacentHTML('beforeend', 'page <b>' + curPage + '</b> of <b>' + last_page + '</b></br>');

            href = window.location.href;
            href = href.substring(0, href.lastIndexOf('/') + 1) + 'list_book.html?page=';


            var first = document.createElement('a');
            var prev = document.createElement('a');
            var next = document.createElement('a');
            var last = document.createElement('a');


            if (curPage > first_page) {
                panel.insertAdjacentElement('beforeend', first);
                panel.insertAdjacentElement('beforeend', prev);
            }

            if (curPage < last_page) {
                panel.insertAdjacentElement('beforeend', next);
                panel.insertAdjacentElement('beforeend', last);
            }
            // redirect

            first.textContent = "first";
            first.className = "item_page_panel";
            first.href = href + first_page;

            next.textContent = "next";
            next.className = "item_page_panel";
            next.href = href + (curPage - (-1));

            prev.textContent = "prev";
            prev.className = "item_page_panel";
            prev.href = href + (curPage - 1);

            last.textContent = "last";
            last.className = "item_page_panel";
            last.href = href + last_page;

        }

        function ShowData(table) {

            query = window.location.search.substring(1);

            query_string = parse_query_string(query);

            dt = document.getElementById("my_file_output");

            var start = 0;
            var end = table.length;

            var numberOfPage = Math.floor(table.length / 10) + 1;

            var pageNumber = 1;

            if (table.length > 10) {

                if (typeof query_string["page"] === "undefined") {
                    // show page 1
                    start = 0;
                    end = 9;
                }
                else {
                    pageNumber = query_string["page"];

                    if (pageNumber <= 0 || pageNumber > numberOfPage) {
                        // redirect
                        href = window.location.href;

                        href = href.substring(0, href.lastIndexOf('/') + 1) + 'error_page_not_found.html?href=' + href;

                        window.location.href = href;
                    }
                    start = 10 * (pageNumber - 1);

                    end = (table.length < start + 10) ? table.length : start + 10;
                }
            }

            f = document.getElementById("debug");
            f.textContent = 'START: ' + start + ' | END: ' + end + ' | PAGE: ' + query_string["page"];

            for (var j = start; j < end; ++j) {

                ele = table[j];
                dt.insertAdjacentHTML('beforeend', '<a href="buy.html?selectedItem=' + ele["id"] + '">' + ele["book_name"] + ' - ' + ele["author"] + '</a>' + ' | ' + ele["donator_id"] + '<br>');
            }

            // show page panel
            ShowSelectPagePanel(table, dt, pageNumber);

        }

        /* set up XMLHttpRequest */
        // url to a public read permission file
        var url = "https://docs.google.com/spreadsheets/d/1wHg-69ZJaVe5MNp6AVpTTCJikl_6dXwwiPjrxNcwQMY/export?type=xlsx";

        var oReq = new XMLHttpRequest();
        oReq.open("GET", url, true);
        oReq.responseType = "arraybuffer";

        oReq.onload = function (e) {
            var arraybuffer = oReq.response;

            /* convert data to binary string */
            var data = new Uint8Array(arraybuffer);

            var arr = new Array();
            for (var i = 0; i != data.length; ++i) {
                arr[i] = String.fromCharCode(data[i]);
            }

            var bstr = arr.join("");
            var cfb = XLSX.read(bstr, { type: 'binary' });
            var sh = cfb.Sheets[cfb.SheetNames[0]];
            table = XLSX.utils.sheet_to_json(sh);

            ShowData(table);
        }


        oReq.send();
    </script>

    <script type="text/javascript">
        // send request to buy
        function httpGetAsync(theUrl, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                    callback(xmlHttp.responseText);
            }
            xmlHttp.open("GET", theUrl, true); // true for asynchronous 
            xmlHttp.send(null);
        }


    </script>

    <h4>Danh sách Book</h4>
    <a href="https://docs.google.com/spreadsheets/d/1wHg-69ZJaVe5MNp6AVpTTCJikl_6dXwwiPjrxNcwQMY/edit?usp=sharing">Link spreadsheet để đối chiếu data đây</a>

    <p id="debug"> </p>

    <p> Vui lòng chọn sách bạn muốn mượn </p>
    <div id="my_file_output" class = "center">
    </div>
</body>

</html>