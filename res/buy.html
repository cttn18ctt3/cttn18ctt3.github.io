<html>

<head>
    <title>Buy a Item</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.12.4/xlsx.core.min.js"></script>

</head>

<body>
    </div id="result">

    <script type="text/javascript">

        var query = "";
        var query_string;
        var book_param = "";

        function parse_query_string(query) {
            var vars = query.split("&");
            var query_string = {};
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                var key = decodeURIComponent(pair[0]);
                var value = decodeURIComponent(pair[1]);
                // If first entry with this name
                if (typeof query_string[key] === "undefined") {
                    query_string[key] = decodeURIComponent(value);
                    // If second entry with this name
                } else if (typeof query_string[key] === "string") {
                    var arr = [query_string[key], decodeURIComponent(value)];
                    query_string[key] = arr;
                    // If third or later entry with this name
                } else {
                    query_string[key].push(decodeURIComponent(value));
                }
            }
            return query_string;
        }


        $(document).ready(function () {

            query = window.location.search.substring(1);

            query_string = parse_query_string(query);

            //
            var submit = $("button[type='submit']");
            submit.click(function () {
                dt = document.getElementById("mess_area");
                while (dt.firstChild) {
                    dt.removeChild(dt.firstChild);
                }
                var data = $('form#test-form').serialize();

                data = "&cmd=insertData&" + data + book_param + "&status=Chờ xác nhận";
                $.ajax({
                    type: 'POST',
                    url: 'https://script.google.com/macros/s/AKfycbyBXyR1Q5jw0g241-jOOq6to2i6SbAVVzh6DzrVF5aGK-GpXWad/exec',
                    dataType: 'json',
                    crossDomain: true,
                    data: data,
                    success: function (data) {

                        alert(JSON.stringify(data));

                        dt = document.getElementById("mess_area");
                        if (data["result"] == 'false') {
                            dt.insertAdjacentHTML('beforeend', '<font color="red">Error, can upload data!</font><br>');

                        } else {
                            dt.insertAdjacentHTML('beforeend', '<font color="green">Upload data complete!</font><br>');

                        }
                    }
                });
                return false;
            });

        });
    </script>


    <script>
        // this for show data
        var table = new Array();

        function ShowData(table) {

            dt = document.getElementById("my_file_output");



            var cell = null;

            for (var j = 0; j < table.length; ++j) {

                if (table[j]["id"] == query_string["selectedItem"]) {
                    cell = table[j];
                };
            }

            if (typeof query_string["selectedItem"] === "undefined" || cell == null) {
                dt.insertAdjacentHTML('beforeend', '<font color="red">Can\'t located book in bookself</font>');
                form = document.getElementById("form_area");

                // remove all child from div form
                while (form.firstChild) {
                    form.removeChild(form.firstChild);
                }

            }
            else {
                book_param = book_param + "&id_book=" + query_string["selectedItem"]
                    + "&book_name=" + cell["book_name"];

                dt.insertAdjacentHTML('beforeend', '<p>You\'ve selected: ' + cell["book_name"] + ' - ' + cell["author"] + '</p>');
                dt.insertAdjacentHTML('beforeend', '<p>Thể lọai: ' + cell["category"] + '</p>');
                dt.insertAdjacentHTML('beforeend', '<p>Tóm tắt nội dung: ' + cell["description"] + '</p>');

                dt.insertAdjacentHTML('beforeend', '</br>' + '<p>Người quyên góp: ' + cell["name"] + ' - ' + cell["donator_id"] + '</p>');

            }


        }

        /* set up XMLHttpRequest */
        // url to a public read permission file
        var url = "https://docs.google.com/spreadsheets/d/1wHg-69ZJaVe5MNp6AVpTTCJikl_6dXwwiPjrxNcwQMY/export?type=xlsx";

        var oReq = new XMLHttpRequest();
        oReq.open("POST", url, true);
        oReq.responseType = "arraybuffer";

        oReq.onload = function (e) {
            var arraybuffer = oReq.response;

            /* convert data to binary string */
            var data = new Uint8Array(arraybuffer);

            var arr = new Array();
            for (var i = 0; i != data.length; ++i) {
                arr[i] = String.fromCharCode(data[i]);
            }

            var bstr = arr.join("");
            var cfb = XLSX.read(bstr, { type: 'binary' });
            var sh = cfb.Sheets[cfb.SheetNames[0]];
            table = XLSX.utils.sheet_to_json(sh);

            ShowData(table);
        }


        oReq.send();
    </script>


    <h4>Mượn sách</h4>
    <a href="https://docs.google.com/spreadsheets/d/1wHg-69ZJaVe5MNp6AVpTTCJikl_6dXwwiPjrxNcwQMY/edit?usp=sharing">Link
        spreadsheet (Book) để đối chiếu data đây</a></br>
    <a href="https://docs.google.com/spreadsheets/d/1GXmma2ISyI7vcnL8psZ-FFByzVFe6oIuQ0RnzfkmWLY/edit?usp=sharing">Link
        spreadsheet (Danh sách mượn) để đối chiếu data đây</a></br>
    <p> Đây là sách bạn vừa chọn: </p></br>
    <div id="my_file_output">
    </div>
    </br>

    <div id="form_area">

        <b>Điền thông tin cá nhân vô để mượn nè: </b> </br></br>
        <form id="test-form" autocomplete="off">
            <input type="text" id='name' name="name" placeholder="Họ Tên" /> <br /><br />
            <input type="text" id='id_user' name="id_user" placeholder="MSSV" /> <br /><br />
            <input type="text" id='email' name="email" placeholder="Email" /> <br /><br />
            <input type="text" id='phone' name="phone" placeholder="Số điện thoại" /> <br /><br />

            <input type="text" id='delivery_date' name="delivery_date" placeholder="Thời gian muốn nhận" /> <br />

            <input type="text" id='address' name="address" placeholder="Địa điểm muốn nhận" /> <br /><br />


            <input type="text" id='note' name="note" placeholder="Ghi chú" /> <br />


            <div id="mess_area"> </div>
            <button type="submit" id="submit-form">Gửi</button>
        </form>
    </div>

</body>

</html>